sequenceDiagram
    autonumber

    actor User
    participant Register
    participant Metadata
    participant Calculator_class
    participant Calculator
    participant Automat
    participant Client
    participant FeatureRegistry
    participant DB

    %% 1) Metadata object is instantiated and registers itself
    User->>Metadata: instantiate Metadata(...)
    Metadata->>Register: registerMetadata(this)

    %% 2) Class definition (conceptual)
    Note over Calculator_class: encapsulates Metadata objects

    %% 3) Calculator instantiated and registered
    User->>Calculator: instantiate Calculator(metadata_list)
    Calculator->>Register: registerCalculator(this)

    %% 4) Automat receives config
    Automat->>Automat: prepare environment + all arguments
    User->>Automat: instantiate Automat(config)

    %% 5) Automat resolves calculators and runs compute()
    Automat->>Register: getCalculators(names)
    Register-->>Automat: list of calculators

    loop each calculator
        Automat->>Calculator: compute(all arguments)
        Calculator->>Calculator: selects relevant arguments
        Calculator-->>Automat: {metadata: data}
    end

    %% 6) Automat passes dict to Client
    Automat->>User: return {metadata + data}
    User->>Client: send {metadata+data}

    %% 7) Client validates metadata against DB
    loop for each metadata+data
        Client->>FeatureRegistry: find(metadata)

        alt metadata unknown
            FeatureRegistry-->>Client: not found
            Client->>FeatureRegistry: create(metadata)
            Client->>DB: insert all data
        else metadata exists
            FeatureRegistry-->>Client: found entry
            Client->>FeatureRegistry: verify consistency

            alt verification OK
                Client->>DB: write changed values only
            else verification fails
                Note right of Client: Handle mismatch (error/log)
            end
        end
    end

    Client-->>User: done
